---
layout: post
title: "[SpringBoot] ë°ì´í„° ë² ì´ìŠ¤ ì‚¬ìš©í•˜ê¸°"
description: " "
date: 2021-06-07
tags: [SpringBoot]
comments: true
share: true
---


# ğŸ§³ ë°ì´í„° ë² ì´ìŠ¤ ì‚¬ìš©í•˜ê¸°

[ëª©í‘œ]

- In-Memory ë°ì´í„° ë² ì´ìŠ¤(H2) ì‚¬ìš©í•˜ê¸°
- MariaDB ì—°ê²°í•˜ê¸°
- Spring-Data-JPA ì‚¬ìš©í•˜ê¸°

<br>

### In-Memory ë°ì´í„° ë² ì´ìŠ¤ ì‚¬ìš©í•˜ê¸°

> - ìŠ¤í”„ë§ ë¶€íŠ¸ì—ì„œ ì§€ì›í•˜ëŠ” In-Memory ë°ì´í„°ë² ì´ìŠ¤ : H2, HSQL, Derby
> - ê·¸ ì¤‘ H2 ì˜ì¡´ì„± ì¶”ê°€í•´ì„œ ì‚¬ìš©í•´ë³´ê¸°

<br>

#### 1. ë¶€íŠ¸ í”„ë¡œì íŠ¸ íŒŒì¼ ì„¤ì •

##### >>> ì˜ì¡´ì„± ì¶”ê°€í•˜ê¸°

[pom.xml] : Spring-boot-starter-jdbc ì˜ì¡´ì„± ì¶”ê°€ => ì„¤ì •ì´ í•„ìš”í•œ bean ìë™ ì„¤ì •

```xml
<dependency>
 <groupId>com.h2database</groupId>
 <artifactId>h2</artifactId>
 <scope>runtime</scope>
</dependency>
<dependency>
 <groupId>org.springframework.boot</groupId>
 <artifactId>spring-boot-starter-jdbc</artifactId>
</dependency>
```

<br>

##### >>> ì½”ë“œ ì‘ì„±

[DBRunner.java] : Connectionrê³¼ DataSourceë¡œ ì—°ê²°ì •ë³´ ë°›ì•„ì˜¤ê¸°

```java
@Component
@Order(1)
public class DBRunner implements ApplicationRunner{

	@Autowired
	private DataSource dataSource;

	private Logger logger = LoggerFactory.getLogger(DBRunner.class);


	@Override
	public void run(ApplicationArguments args) throws Exception {

		logger.info("=====>> connection ===========");
		Connection connection = dataSource.getConnection();
		DatabaseMetaData dbMeta = connection.getMetaData();
		logger.debug("DB URL : " + dbMeta.getURL());
		logger.debug("DB Username : " +dbMeta.getUserName());
		logger.info("=====>> end =============");
	}
}
```

[ì½˜ì†”]

    =====>> connection ===========
    DB URL : jdbc:h2:mem:testdb
    DB Username : SA
    =====>> end =============

<br>

#### 2. ì›¹ ë¸Œë¼ìš°ì € : H2 DB ê´€ë¦¬ ê°€ëŠ¥

localhost:8087/h2-consoleë¡œ ì ‘ì†

![](./imgs/2.h2.png)

JDBC URL ì½˜ì†”ì— ë‚˜ì˜¨ ê°’ìœ¼ë¡œ ë³€ê²½

![](./imgs/2.h3.png)

Connectí›„ í™”ë©´

![](./imgs/2.h4.png)

<br><br>

### MariaDB ì‚¬ìš©í•˜ê¸°

> - **ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” DBCP** (DataBase Connection Pooling)
>
> 1. HikariDP ( - spring.datasource.hikrai.\*)
> 2. Tomcat CP ( - spring.datasource.tomcat.\*)
> 3. Commons DBCP2 ( - spring.datasource.dbcp2)
>
> - MySQL ì»¤ë„¥í„° ì˜ì¡´ì„±ê³¼ MySQL Datasource ì„¤ì •ìœ¼ë¡œ MariaDBì— ì—°ê²°í•  ìˆ˜ ìˆìŒ

<br>

##### >>> ì˜ì¡´ì„± ì¶”ê°€í•˜ê¸°

[pom.xml] : MySQL ì»¤í…í„° ì˜ì¡´ì„± ì¶”ê°€

```xml
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.13</version>
</dependency>
```

##### >>> í™˜ê²½ ì„¤ì •

[application.properties] MySQL DataSource ì„¤ì •

```xml
#mysql ì„¤ì •
spring.datasource.url=jdbc:mysql://127.0.0.1:3306/spring_db?useUnicode=true&charaterEncoding=utf-8&useSSL=false&serverTimezone=UTC
spring.datasource.username=spring
spring.datasource.password=spring
spring.datasource.driverClassName=com.mysql.cj.jdbc.Driver
```

[í„°ë¯¸ë„ë¡œ Maria DBì— ì ‘ì† ë° ë°ì´í„° ì¶”ê°€] : MySQL Database ìƒì„±

```sql
mysql -u root â€“p
show databases;
use mysql;
create user spring@localhost identified by 'spring';
grant all on *.* to spring@localhost;
flush privileges;
exit;
mysql -u spring -p
create database spring_db;
show databases;
use spring_db;
```

![](./imgs/2.terminalPic.png)

<br><br>

### Spring-Data-JPA ì‚¬ìš©í•˜ê¸°

#### ORMê³¼ JPA ë€?

> - **ORM**(Object-Relational Mapping) : ê´€ê³„í˜• DBí…Œì´ë¸”ì„ ê°ì²´ì§€í–¥ì ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ê°ì²´ì™€ ê´€ê³„ë¥¼ ì—°ê²°í•´ì¤Œ (DBí…Œì´ë¸” ìì²´ë¥¼ ê°ì²´ë¡œ ì‚¬ìš©)
> - **JPA**(Java Persistance API) : ORM í‘œì¤€ê¸°ìˆ ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ë¥¼ ê°ì²´ ì§€í–¥ìœ¼ë¡œ ì‰½ê²Œ ì ìš©í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤Œ
> - ê·¸ ì¤‘, ìŠ¤í”„ë§ë¶€íŠ¸ëŠ” Hibernateë¡œ êµ¬í˜„

![](./imgs/2.orm_jpa.png)

<br>

#### Spring-Data-JPAì˜ íŠ¹ì§•

> - JPAë¥¼ ì‰½ê²Œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ìŠ¤í”„ë§ì—ì„œ ì œê³µí•˜ëŠ” í”„ë ˆì„ì›Œí¬
> - Repository Beanì„ ìë™ìƒì„±
> - ì¿¼ë¦¬ ë©”ì†Œë“œ ìë™êµ¬í˜„
> - @EnalbeJpaRepositories (ìŠ¤í”„ë§ë¶€íŠ¸ê°€ ìë™ìœ¼ë¡œ ì„¤ì •í•´ì¤Œ)

<br>

##### >>> ì˜ì¡´ì„± ì¶”ê°€í•˜ê¸°

[pom.xml] : Spring-Data-JPAì™€ spring-boot-starter-test ì˜ì¡´ì„± ì¶”ê°€

```xml
<!-- Spring Data JPA -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>

<!-- Spring Boot Starter Test -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <!-- scope testëŠ” test directoryì•ˆì—ì„œë§Œ ì˜ì¡´ì„±ì´ ë™ì‘í•œë‹¤ëŠ” ëœ» -->
    <scope>test</scope>
</dependency>
```

<br>

##### >>> ì½”ë“œ ì‘ì„±

[ì‚¬ìš© ì–´ë…¸í…Œì´ì…˜ ë¨¼ì € ì•Œê¸°]

| ì–´ë…¸í…Œì´ì…˜      | ê¸°ëŠ¥                                                                                                          |
| --------------- | ------------------------------------------------------------------------------------------------------------- |
| @Entity         | - ì—”í‹°í‹° í´ë˜ìŠ¤ì„ì„ ì§€ì •í•˜ë©° **DB í…Œì´ë¸”**ê³¼ ë§¤í•‘í•˜ëŠ” ê°ì²´ë¥¼ ë‚˜íƒ€ëƒ„                                           |
| @Id             | - ì—”í‹°í‹°ì˜ **ê¸°ë³¸í‚¤**ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì–´ë…¸í…Œì´ì…˜ì…ë‹ˆë‹¤.                                                            |
| @GeneratedValue | - ì£¼ í‚¤ì˜ ê°’ì„ **ìë™ ìƒì„±**í•˜ê¸° ìœ„í•´ ëª…ì‹œí•˜ëŠ” ë° ì‚¬ìš© <br> -ìë™ ìƒì„± ì „ëµ : AUTO, IDENTITY, SEQUENCE, TABLE |

**ì•¤í‹°í‹°(Entity)ë€** ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í‘œí˜„í•˜ë ¤ê³  í•˜ëŠ” ìœ í˜•, ë¬´í˜•ì˜ ê°ì²´ë¡œì„œ ì„œë¡œ êµ¬ë³„ë˜ëŠ” ê²ƒì„ ëœ»í•¨. ì´ ê°ì²´ë“¤ì€ DB ìƒì—ì„œëŠ” ë³´í†µ tableë¡œì„œ ë‚˜íƒ€ë‚¨

**ê°ì²´ <=> DB ë§¤í•‘**

    - í´ë˜ìŠ¤(ì—”í‹°í‹°) <=> í…Œì´ë¸”
    - ê°ì²´ <=> Row (í–‰)
    - ë³€ìˆ˜ <=> Column (ì—´)

<br>

[Account.java] : DB Account í…Œì´ë¸” ìƒì„±í•˜ê¸°

```java
@Entity
public class Account {
	@Id @GeneratedValue(strategy = GenerationType.IDENTITY)
	//primary keyë§Œë“¤ê¸°
	private Long id;

	@Column(unique = true)
	private String username;

	private String password;

	public Long getId() {
		return id;
	}

	public void setId(Long id) {
		this.id = id;
	}

	public String getUsername() {
		return username;
	}

	public void setUsername(String username) {
		this.username = username;
	}

	public String getPassword() {
		return password;
	}

	public void setPassword(String password) {
		this.password = password;
	}

	@Override
	public String toString() {
		return "Account [id=" + id + ", username=" + username + ", password=" + password + "]";
	}
}
```

<br>

[AccountRepository.java] : Repository ì¸í„°í˜ì´ìŠ¤ ì‘ì„±

> - AccountRepositoryì˜ êµ¬í˜„í´ë˜ìŠ¤ë¥¼ ë”°ë¡œ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ Spring-Data-JPAê°€ ìë™ì ìœ¼ë¡œ í•´ë‹¹ ë¬¸ìì—´ usernameì— ëŒ€í•œ ì¸ìˆ˜ë¥¼ ë°›ì•„ ìë™ì ìœ¼ë¡œ DB Tableì— ë§¤í•‘
> - JpaRepository<ì—”í‹°í‹° í´ë˜ìŠ¤, í”„ë¼ì´ë¨¸ë¦¬ í‚¤ íƒ€ì…>
> - JpaRepositoryì˜ ìƒìœ„ ê°ì²´ CrudRepositoryê°€ ì´ë¯¸ ì—¬ëŸ¬ ë§¤ì†Œë“œë¥¼ êµ¬í˜„í•´ ë†“ê¸° ë•Œë¬¸ì— ì—†ëŠ”ê²ƒë“¤ë§Œ ì—¬ê¸°ì— ì €ì¥í•´ë‘ 
> - ì°¸ì¡° : https://attacomsian.com/blog/spring-data-jpa-auditing#further-reading

**CrudRepository** êµ¬í˜„ ë©”ì†Œë“œë“¤:

- save(), saveAll()
- findById(), findAll(), findAllById()
- count()
- delete(), deleteById(), deleteAll()

<br>

```java
public interface AccountRepository extends JpaRepository<Account, Long>{

    //findBy(columnëª…)
    Account findByUsername(String username);
}
```

[applicaion.properties] : JPAë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìë™ ì´ˆê¸°í™”í•˜ë„ë¡ ì„¤ì •

```xml
#SQL ì„¤ì •
spring.jpa.hibernate.ddl-auto=create
spring.jpa.show-sql=true
```

<br>

[jpa ì„¤ì •ì˜µì…˜]

**spring.jpa.hibernate.ddl-auto=** create|create-drop|update|validate

**1. create**

> JPAê°€ DBì™€ ìƒí˜¸ì‘ìš©í•  ë•Œ ê¸°ì¡´ì— ìˆë˜ ìŠ¤í‚¤ë§ˆ(í…Œì´ë¸”)ì„ ì‚­ì œí•˜ê³  ìƒˆë¡œ ë§Œë“¬

**2. create-drop**

> JPA ì¢…ë£Œ ì‹œì ì— ê¸°ì¡´ì— ìˆì—ˆë˜ í…Œì´ë¸”ì„ ì‚­ì œ

**3. update**

> ê¸°ì¡´ ìŠ¤í‚¤ë§ˆëŠ” ìœ ì§€í•˜ê³ , ìƒˆë¡œìš´ ê²ƒë§Œ ì¶”ê°€í•˜ê³ , ê¸°ì¡´ì˜ ë°ì´í„°ë„ ìœ ì§€/ ë³€ê²½ëœ ë¶€ë¶„ë§Œ ë°˜ì˜í•¨
> ì£¼ë¡œ ê°œë°œ í•  ë•Œ ì í•©

**4.validate**

> ì—”í‹°í‹°ì™€ í…Œì´ë¸”ì´ ì •ìƒ ë§¤í•‘ ë˜ì–´ ìˆëŠ”ì§€ë¥¼ ê²€ì¦

**spring.jpa.show-sql=true**

> JPAê°€ ìƒì„±í•œ SQLë¬¸ì„ ë³´ì—¬ì¤„ ì§€ì— ëŒ€í•œ ì—¬ë¶€ë¥¼ ì•Œë ¤ì¤Œ

<br>

[src/test/java/AppRepoTest.java] : ì‹¤ì œë¡œ ì¿¼ë¦¬ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ jUnit í™•ì¸

```java
@RunWith(SpringRunner.class)
@SpringBootTest
public class AppRepoTest {
	@Autowired
	private AccountRepository repository;

	@Test
	public void account() throws Exception {
		System.out.println(repository.getClass().getName());
		//1. Account ê°ì²´ ìƒì„± -> ë“±ë¡
		Account account = new Account();
		account.setUsername("Spring2");
		account.setPassword("1234");

		Account addAccount = repository.save(account);
		System.out.println(addAccount.getId() + " " + addAccount.getUsername());
	}
}
```

[ì½˜ì†”] : hibernateê°€ ì¿¼ë¦¬ë¬¸ì„ ì‹¤í–‰
![](./imgs/2.hibernate.png)

[jUnit ì‹¤í–‰ê²°ê³¼] : ì •ìƒ ì‘ë™

![](./imgs/2.junit.png)

[tableí™•ì¸] : ì¶”ê°€í•œ ë°ì´í„° í™•ì¸

![](./imgs/2.teminal2.png)

<br>

#### + ddl-auto : validate í™•ì¸í•´ë³´ê¸°

[applicaion.properties]

```xml
#SQL ì„¤ì •
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.show-sql=true
```

[Account.java] : emailê°’ ì¶”ê°€í•´ë³´ê¸°

```java
@Entity
public class Account {
	@Id @GeneratedValue(strategy = GenerationType.IDENTITY)
	//primary keyë§Œë“¤ê¸°
	private Long id;

	@Column(unique = true)
	private String username;

	@Column
	private String password;

	@Column
	private String email;

	public String getEmail() {
		return email;
	}

    (...)
}
```

[src/test/java/AppRepoTest.java] : ë‹¤ì‹œ ì‚¬ìš©ì ì¶”ê°€ ê°€ëŠ¥í•œì§€ í™•ì¸ / ì½”ë“œ ìˆ˜ì •ì—†ìŒ

[ì½˜ì†” ì—ëŸ¬] : validateë¡œ ë³€ê²½í•˜ê³  emailì¶”ê°€ ì‹œ, ì½˜ì†”ì— ì—ëŸ¬ ë°œìƒ

![](./imgs/2.validate.png)

[applicaion.properties] : ë‹¤ì‹œ updateë¡œ ë³€ê²½ì‹œ ì •ìƒ ì‘ë™

```xml
#SQL ì„¤ì •
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
```

[ë°ì´í„° í™•ì¸] : email column ìƒì„±
![](./imgs/2.terminal3.png)

<br>

#### + Optional ê°ì²´ ì‚¬ìš©í•´ë³´ê¸°

> - **Optional ê°ì²´ ë°˜í™˜**
> - Java8ì€ í•¨ìˆ˜í˜• ì–¸ì–´ì˜ ì ‘ê·¼ ë°©ì‹ì—ì„œ ì˜ê°ì„ ë°›ì•„ java.util.Optional<T>ë¼ëŠ” ìƒˆë¡œìš´ í´ë˜ìŠ¤ë¥¼ ë„ì…
> - **Optional**: â€œì¡´ì¬í•  ìˆ˜ë„ ìˆì§€ë§Œ ì•Š í•  ìˆ˜ë„ ìˆëŠ” ê°ì²´â€, â€nullì´ ë  ìˆ˜ë„ ìˆëŠ” ê°ì²´â€ ë¥¼ ê°ì‹¸ê³  ìˆëŠ” ì¼ì¢…ì˜ ë˜í¼ í´ë˜ìŠ¤
> - ëª…ì‹œì ìœ¼ë¡œ í•´ë‹¹ ë³€ìˆ˜ê°€ nullì¼ ìˆ˜ë„ ìˆë‹¤ëŠ” ê°€ëŠ¥ì„±ì„ í‘œí˜„íˆì—¬ ë¶ˆí•„ìš”í•œ NullPointException ë°©ì–´ ë¡œì§ì„ ì¤„ì¼ ìˆ˜ ìˆìŒ
> - Optionalì— ì €ì¥ëœ ê°ì²´ì˜ ê°’ì´ ìˆìœ¼ë©´ True ì—†ìœ¼ë©´ null(False)

<br>

#### usernameê³¼ idë¡œ í…Œì´ë¸” ì¡°íšŒ í•´ë³´ê¸°

[AccountRepository.java]

```java
public interface AccountRepository extends JpaRepository<Account, Long>{
	Account findByUsername(String username);

    //optional ì¶”ê°€
    // Optional<ê°ì²´> : ê°ì²´ëŠ” ì •ìƒì ì¼ìˆ˜ë„, nullì¼ìˆ˜ë„
	Optional<Account> findByEmail(String email);
}
```

[Test.java] :

```java

@RunWith(SpringRunner.class)
@SpringBootTest

public class AppRepoTest {

	@Autowired
	private AccountRepository repository;

	@Test
	public void finder() {
        //tableì— ì—†ëŠ” username ë¶ˆëŸ¬ë³´ê¸°
        //nullê°’ ì¶œë ¥
	Account account = repository.findByUsername("lambda2");
	System.out.println(account);

        //Optionalì— ì €ì¥ëœ Accountê°ì²´ì˜ ê°’ì´ ìˆìœ¼ë©´
        // TrueOptionalì— ì €ì¥ëœ Accountê°ì²´ì˜ ê°’ì´ ì—†ìœ¼ë©´ (null) False

	Optional<Account> optional = repository.findById(1L);
	System.out.println(optional.isPresent());
	}
}
```

[ì½˜ì†” ì¶œë ¥]
![](./imgs/2.optional1.png)

[Test.java] : Optionalì ìš© í›„ ì—†ëŠ” Emailê°’ ì°¾ì•„ë³´ê¸°

```java
@RunWith(SpringRunner.class)
@SpringBootTest

public class AppRepoTest {
	@Autowired
	private AccountRepository repository;

	@Test
	public void finder() {
        //tableì— ì—†ëŠ” ID ë¶ˆëŸ¬ë³´ê¸°
        //nullê°’ ì¶œë ¥
	Account account = repository.findByUsername("lambda2");
	System.out.println(account);

        //idê°€ 1ë²ˆì¸ accountê°ì²´ê°€ ì¡´ì¬í•˜ëŠ”ì§€ optionalì´ ì¶œë ¥
        //true
	Optional<Account> optional = repository.findById(1L);
	System.out.println(optional.isPresent());


        // <ìš”ì²­í•œ ì•„ì´ë””ê°€ ìˆìœ¼ë©´ Accountê°ì²´ ë°˜í™˜, ì—†ìœ¼ë©´ ì˜ˆì™¸ ë°œìƒí•˜ë„ë¡ ì„¤ì •>

        // optional ì„¤ì • í›„ ë°›ì•„ì˜¤ê¸°
	if(optional.isPresent()) {
	    Account account2 = optional.get();
	    System.out.println(account2);
        //ì½˜ì†” Print
        // optional.get() : Account [id=1, username=Spring, password=1234]
	}

        //ì—†ëŠ” ì´ë©”ì¼ ì£¼ì†Œë¡œ ì°¾ì•„ë³´ê¸°
	Optional<Account> optEmail = repository.findByEmail("lambda1@gmail.com");

	//Supplier í•¨ìˆ˜í˜• ì¸í„°í˜ì´ìŠ¤ì¶”ìƒ ë©”ì†Œë“œ T get()ì‚¬ìš©
	Account account3 = optEmail.orElseThrow(()-> new RuntimeException("ìš”ì²­í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ê°€ì§„ Accountê°€ ì—†ìŠµë‹ˆë‹¤. "));
	System.out.println(account3);
	}
}
```

[jUnit Testê²°ê³¼] : ì˜ˆì™¸ ì²˜ë¦¬ ë°œìƒ
![](./imgs/2.optional2.png)

<br>

#### Eamilê°’ ì—…ë°ì´íŠ¸ í•´ë³´ê¸°

[test.java] : ì—…ë°ì´íŠ¸ ë©”ì†Œë“œ ì¶”ê°€ í›„ ì‹¤í–‰

```java
@Test
public void update() {
    Optional<Account> optFindById = repository.findById(2L);

    //ìš”ì²­í•œ ì•„ì´ë””ì™€ ì¼ì¹˜í•˜ëŠ” ê°ì¹˜ê°€ ìˆì„ ê²½ìš°
    if(optFindById.isPresent()) {
	Account account = optFindById.get();
	account.setEmail("changed@email.com");
	repository.save(account);
	}
}
```

[ì½˜ì†” ì¶œë ¥] : Email ê°’ì´ null=> changed@email.comìœ¼ë¡œ ë³€ê²½

![](./imgs/2.update.png)
