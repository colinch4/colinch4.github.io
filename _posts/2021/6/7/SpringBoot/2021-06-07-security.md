---
layout: post
title: "[SpringBoot] Spring Boot Security ìŠ¤í”„ë§ ë¶€íŠ¸ ì¸ì¦ì‹œìŠ¤í…œ"
description: " "
date: 2021-06-07
tags: [springboot]
comments: true
share: true
---

## ğŸ” Spring Boot Security ìŠ¤í”„ë§ ë¶€íŠ¸ ì¸ì¦ì‹œìŠ¤í…œ

[ëª©í‘œ]

- ìŠ¤í”„ë§ë¶€íŠ¸ì˜ ì¸ì¦ ì‹œìŠ¤í…œ ì‚¬ìš©í•´ë³´ê¸°
- ì—¬ëŸ¬ ìœ ì €ë¡œ ì ‘ì† ê°€ëŠ¥í•œ ì¸ì¦ì‹œìŠ¤í…œ ë„£ì–´ë³´ê¸°

<br>

### Spring Boot Security íŠ¹ì§•

> - ì›¹ê³¼ ë©”ì„œë“œì— ì‹œíë¦¬í‹° ê¸°ëŠ¥ ì œê³µ
> - Basic ì¸ì¦, Form ì¸ì¦, OAuth, LDAPë“± ë‹¤ì–‘í•œ ì¸ì¦ ë°©ë²• ì§€ì›
> - ìŠ¤í”„ë§ ë¶€íŠ¸ ì‹œíë¦¬í‹° ìë™ ì„¤ì •ì— í•„ìš”í•œ ì„¤ì •
>   **@SecurityAutoConfiguration** & **UserDetailsServiceAutoConfiguration**
> - ì²˜ìŒì— ê¸°ë³¸ ì‚¬ìš©ìë¥¼ ìë™ìœ¼ë¡œ ìƒì„±
>   - Username : user
>   - Password : ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•  ë•Œ ë§ˆë‹¤ ëœë¤ ê°’ ìƒì„± (ì½˜ì†”ì— ì¶œë ¥ë¨)

- ì°¸ê³  : https://docs.spring.io/spring-boot/docs/2.1.1.RELEASE/reference/htmlsingle/#boot-features-security-mvc

<br><br>

### Security êµ¬í˜„í•˜ê¸°

<br>

#### 1. spring-boot-starter-security ì˜ì¡´ì„± ì¶”ê°€

[pom.xml]

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

<br>

- ì¶”ê°€ í›„ ì½˜ì†”ì°½ì— ì¸ì¦ë²ˆí˜¸ ì¶œë ¥

![](./imgs/security/security2.png)

<br>

- ì›¹í˜ì´ì§€ ì ‘ì† : localhost:8087

> Id: user / password : ì½˜ì†”ì°½ ì¸ì¦ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸

![](./imgs/security/security1.png)

<br>

#### 2. index.htmlê³¼ controller.javaì— ì½”ë“œ ì¶”ê°€

**[index.html]** : ë©”ì¸í˜ì´ì§€ì— /mypage url ë§í¬íƒœê·¸ ì…ë ¥

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Insert title here</title>
  </head>
  <body>
    <h1>HELLO EVERYONE</h1>
    <h2>WELCOME</h2>
    <h3>
      <a href="/index"> >> ì‚¬ìš©ì ê´€ë¦¬ </a>
    </h3>
    <a href="/mypage">MyPage</a>
  </body>
</html>
```

**[Controller.java]** :/mypage ë§¤í•‘

```java

@Controller
public class UserThymController {

	@Autowired
	UserRepository userRepo;

	@Controller
	public class TemplateController {
	@GetMapping("/mypage") public String mypage() {
	return "mypage"; }
	}
}
```

[ì›¹ ë¸Œë¼ìš°ì €]

![](./imgs/security/security3.png)

<br>

#### 3. mypage.html ìƒì„±

[templates>mypage.html]

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <meta charset="UTF-8" />
  <body>
    <h1>My Page</h1>
    <div>
      Logged in user:
      <b th:inline="text" class="user">
        [[${#httpServletRequest.remoteUser}]]
      </b>
      <br />
      <form th:action="@{/app-logout}" method="POST">
        <input type="submit" value="Logout" />
      </form>
    </div>
  </body>
</html>
```

[/mypage ì›¹ ë¸Œë¼ìš°ì €] : íƒ€ë€~!~!

![](./imgs/security/security4.png)

<br>
<br>

#### 4. index.htmlì™€ mypageì˜ ì ‘ê·¼ ê¶Œí•œ ë‹¬ë¦¬ í•˜ê¸°

**[SecurityConfig.java]** : WebSecurityConfigurerAdapter ìƒì† ë°›ì•„ configure ë§¤ì†Œë“œ ì‚¬ìš©í•˜ê¸°

```java

@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
	protected void configure(HttpSecurity http) throws Exception {
	    http.authorizeRequests()
		.antMatchers("/mypage/**")
		.authenticated()
		.antMatchers("/**")
		.permitAll()
		.and()
		.formLogin()
		.and().httpBasic() // ì—¬ê¸°ê¹Œì§€ indexëŠ” í•„ìš” ì—†ê³  mypageë¡œ ë“¤ì–´ê°ˆë•Œë§Œ ì¸ì¦ í•„ìš”í•˜ë„ë¡
    }

    //passwordë¥¼ ì¸ì½”ë”©í•´ì£¼ëŠ” ë¹ˆ ì¶”ê°€
    @Bean
	public PasswordEncoder passwordEncoder() {
		return PasswordEncoderFactories.createDelegatingPasswordEncoder();
	}
}
```

[/mypage url ì ‘ì† ì‹œ, ì¸ì¦ ìš”êµ¬]

![](./imgs/security/security5.png)

[ì¸ì¦ ì™„ë£Œ]

![](./imgs/security/security4.png)

<br>

#### 5. mypageì— ë¡œê·¸ì•„ì›ƒ êµ¬í˜„í•˜ê¸°

**[SecurityConfig.java]** : ë¡œê·¸ì•„ì›ƒ ì½”ë“œ ì¶”ê°€

```java
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http.authorizeRequests()
		.antMatchers("/mypage/**")
		.authenticated()
		.antMatchers("/**")
		.permitAll()
		.and()
		.formLogin()
		.and().httpBasic() // ì—¬ê¸°ê¹Œì§€ indexëŠ” í•„ìš” ì—†ê³  mypageë¡œ ë“¤ì–´ê°ˆë•Œë§Œ ì¸ì¦ í•„ìš”í•˜ë„ë¡

        // ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ êµ¬í˜„!
		.and()
		.logout()
		.logoutUrl("/app-logout")
        //deleteCookies(ì›¹ ë¸Œë¼ìš°ì € ì¿ í‚¤ Name)ë¡œ ì—°ê²° login ì„¸ì…˜ ëŠì–´ì£¼ê¸°
        //ì•„ë˜ ì´ë¯¸ì§€ ì°¸ì¡°
		.deleteCookies("JSESSIONID")
		.logoutSuccessUrl("/"); //logoutì‹œ ë‹¤ì‹œ ë£¨íŠ¸ë¡œ
	}

}
```

[ì›¹ ë¸Œë¼ìš°ì € ì¿ í‚¤ ]

![](./imgs/security/security7.png)

<br>

#### 6. DBì˜ ìœ ì € ì •ë³´ë¡œ ë¡œê·¸ì¸ í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•˜ê¸°

<br>

**[AccountService.java]** : ì„œë¹„ìŠ¤ Bean ì¶”ê°€í•˜ê¸°

> - UserDetailsServiceë¥¼ ìƒì†ë°›ì•„ Accountë¥¼ ìƒì„±í•˜ëŠ” createAcount() ë©”ì„œë“œ êµ¬í˜„
> - Importì‹œ, ë§Œë“¤ì–´ ë†“ì€ User ê°ì²´ê°€ ì•„ë‹Œ UserDetailë¥¼ ë¶ˆëŸ¬ì™€ì•¼ í•¨
>   `import org.springframework.security.core.userdetails.User`
> - loadUserByUsername() ë§¤ì†Œë“œë¡œ ì…ë ¥í•œ ì •ë³´ê°€ validí•œì§€ ì²´í¬í•¨

| ì–´ë…¸í…Œì´ì…˜     | ê¸°ëŠ¥                                                                                                                  |
| -------------- | --------------------------------------------------------------------------------------------------------------------- |
| @PostConstruct | - ê°ì²´ë¥¼ ìƒì„±í•˜ìë§ˆì ì²˜ë¦¬í•  ì¼ì´ ìˆì„ ë•Œ ì‚¬ìš©í•˜ëŠ” ë§¤ì†Œë“œ <br> - Constructor í˜¸ì¶œ í›„, ë°”ë¡œ @PostConstruct ë§¤ì†Œë“œ ì²˜ë¦¬ |

<br>

```java
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;

@Service
public class AccountService implements UserDetailsService {

	private final AccountRepository repo;

    //properties ê°ì²´ ì‚¬ìš©
	private final KayaProperties props;

	//ìƒì„±ìë¡œ @Autowired ëŒ€ì²´
	public AccountService(AccountRepository repo, KayaProperties props) {
		this.repo = repo;
		this.props = props;
	}

	@Override
    //login í• ë•Œ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì •ë³´ê°€ ìœ íš¨í•œì§€ë¥¼ ì²´í¬í•œë‹¤.
	public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException {
		Optional<Account> userAcc = repo.findByEmail(email);
		Account account = userAcc.orElseThrow(()-> new UsernameNotFoundException("ìš”ì²­í•˜ì‹  "+email + "ì´ ì—†ìŠµë‹ˆë‹¤."));

	//*ì£¼ì˜* Securityì˜ USerì„ Entity(X)
        //User(ID, password, ê¶Œí•œ) í™•ì¸
		return new User(account.getEmail(), account.getPassword(), authorities());
	}

     //ìœ„ì—ì„œ í™•ì¸ í•  User ê°ì²´ì˜ ê¶Œí•œì„¤ì •
     //'ROLE_USER'ì€ ë‚´ì¥ëœ ê°’
	private Collection<? extends GrantedAuthority> authorities() {
		return Arrays.asList(new SimpleGrantedAuthority("ROLE_USER"));
	}

     //ìƒˆë¡œìš´ ì–´ì¹´ìš´íŠ¸ ìƒì„± ë§¤ì†Œë“œ
     //ì„œë¹„ìŠ¤ ê°ì²´ìƒì„±ì‹œ, PostConstructë¥¼ í†µí•´ createAccount í˜¸ì¶œë¨
	public Account createAccount(String email, String password) {
		Account account = new Account();
		account.setEmail(email);

            //SecurityConfigì—ì„œ ì„¤ì •í•´ì¤€ passwordEncoder ë§¤ì†Œë“œì˜ ì„ ë°›ì•„ì˜´
		account.setPassword(passwordEncoder.encode(password));
		return repo.save(account);
	}

	@PostConstruct
    //Service Bean ìƒì„± ì§í›„ì— ë°”ë¡œ í˜¸ì¶œë˜ëŠ” ë§¤ì†Œë“œ
     //ì°¾ëŠ” ê°’ì´ ìˆìœ¼ë©´ ê°€ì ¸ì˜¤ê³ , ì—†ìœ¼ë©´ createAccount()ë¡œ
	public void init() {
		Optional<Account> optEmail = repo.findByEmail(props.getEmail());

		//Emailì£¼ì†Œì™€ ë§¤í•‘ë˜ëŠ” Accountê°€ ì—†ìœ¼ë©´ ë“±ë¡
		if(optEmail.isEmpty()) {
		    Account account = this.createAccount(props.getEmail(), props.getPassword());
		    System.out.println(account);
		}
	}
}
```

<br>

[ì›¹ ë¸Œë¼ìš°ì €] : Account DBì— ì¶”ê°€ëœ ì •ë³´ë¡œ ë¡œê·¸ì¸

![](./imgs/security/security8.png)

![](./imgs/security/security9.png)
