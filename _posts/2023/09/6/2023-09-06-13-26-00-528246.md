---
layout: post
title: "[νμ΄μ¬] Psycopg2μ—μ„ ν…μ¤νΈ λ° mocking"
description: " "
date: 2023-09-06
tags: [python,Psycopg2]
comments: true
share: true
---

ν…μ¤νΈλ” μ†ν”„νΈμ›¨μ–΄ κ°λ° κ³Όμ •μ—μ„ ν•„μμ μΈ μ”μ†μ…λ‹λ‹¤. Psycopg2λ” Pythonμ—μ„ PostgreSQL λ°μ΄ν„°λ² μ΄μ¤μ™€ μƒνΈμ‘μ©ν•κΈ° μ„ν• μΈκΈ° μλ” λΌμ΄λΈλ¬λ¦¬μ…λ‹λ‹¤. μ΄ λΈ”λ΅κ·Έ ν¬μ¤νΈμ—μ„λ” Psycopg2λ¥Ό μ‚¬μ©ν•μ—¬ ν…μ¤νΈ λ° λ¨ν‚Ή(mocking)μ„ ν•λ” λ°©λ²•μ— λ€ν•΄ μ•μ•„λ³΄κ² μµλ‹λ‹¤.

## ν…μ¤νΈν•κΈ° μ „μ—

Psycopg2λ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ² μ΄μ¤μ™€ μƒνΈμ‘μ©ν•λ” μ½”λ“λ¥Ό μ‘μ„±ν•κΈ° μ „μ—, μ•„λμ™€ κ°™μ΄ ν•„μ”ν• ν¨ν‚¤μ§€λ¥Ό μ„¤μΉν•΄μ•Ό ν•©λ‹λ‹¤.

```python
pip install psycopg2
pip install pytest
```

## λ‹¨μ„ ν…μ¤νΈ(Unit Testing)ν•κΈ°

λ‹¨μ„ ν…μ¤νΈλ” κ°λ³„μ μΈ μ½”λ“ μ΅°κ°μ„ ν…μ¤νΈν•λ” κ²ƒμΌλ΅, μ†ν”„νΈμ›¨μ–΄ κ°λ° κ³Όμ •μ—μ„ μ¤‘μ”ν• λ¶€λ¶„μ…λ‹λ‹¤. Psycopg2λ¥Ό μ‚¬μ©ν• μ½”λ“λ¥Ό λ‹¨μ„ ν…μ¤νΈν•κΈ° μ„ν•΄μ„λ” λ‹¤μ λ‹¨κ³„λ¥Ό λ”°λ¥΄λ©΄ λ©λ‹λ‹¤.

1. ν…μ¤νΈμ© λ°μ΄ν„°λ² μ΄μ¤λ¥Ό μ„¤μ •ν•λ‹¤.
2. ν•„μ”ν• ν…μ¤νΈ λ°μ΄ν„°λ¥Ό μ‚½μ…ν•λ‹¤.
3. Psycopg2λ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ² μ΄μ¤μ™€ μƒνΈμ‘μ©ν•λ” μ½”λ“λ¥Ό ν…μ¤νΈν•λ‹¤.
4. ν…μ¤νΈ κ²°κ³Όλ¥Ό ν™•μΈν•λ‹¤.

μ•„λλ” μμ‹ μ½”λ“μ…λ‹λ‹¤.

```python
import psycopg2
import pytest

def test_database_interaction():
    # λ‹¨μ„ ν…μ¤νΈμ© λ°μ΄ν„°λ² μ΄μ¤ μ„¤μ •
    conn = psycopg2.connect(
        host="localhost",
        database="test_db",
        user="test_user",
        password="test_password"
    )
    
    # ν…μ¤νΈ λ°μ΄ν„° μ‚½μ…
    cursor = conn.cursor()
    cursor.execute("CREATE TABLE test_table (id SERIAL PRIMARY KEY, name VARCHAR);")
    cursor.execute("INSERT INTO test_table (name) VALUES ('John');")
    conn.commit()

    # Psycopg2λ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ² μ΄μ¤μ™€ μƒνΈμ‘μ©ν•λ” μ½”λ“ ν…μ¤νΈ
    cursor.execute("SELECT name FROM test_table WHERE id = 1;")
    result = cursor.fetchone()
    assert result[0] == 'John'

    # λ‹¨μ„ ν…μ¤νΈ ν›„ μ •λ¦¬
    cursor.execute("DROP TABLE test_table;")
    conn.commit()
    cursor.close()
    conn.close()
```

μ„μ μ½”λ“μ—μ„λ” `test_database_interaction()` ν•¨μλ¥Ό μ‘μ„±ν•μ—¬ Psycopg2λ¥Ό μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ² μ΄μ¤μ™€ μƒνΈμ‘μ©ν•λ” μ½”λ“λ¥Ό ν…μ¤νΈν•κ³  μμµλ‹λ‹¤. ν…μ¤νΈ κ²°κ³Όλ¥Ό ν™•μΈν•κΈ° μ„ν•΄ `assert` λ¬Έμ„ μ‚¬μ©ν•μ€μµλ‹λ‹¤.

## Mockingμ„ μ‚¬μ©ν•μ—¬ ν…μ¤νΈν•κΈ°

Psycopg2λ¥Ό μ‚¬μ©ν•λ” μ½”λ“λ¥Ό λ‹¨μ„ ν…μ¤νΈν•  λ•, λ°μ΄ν„°λ² μ΄μ¤μ— μ‹¤μ λ΅ μ—°κ²°ν•μ—¬ ν…μ¤νΈν•λ” λ¶€λ¶„μ€ ν…μ¤νΈμ μ†λ„λ¥Ό λ¦μ¶ μ μμµλ‹λ‹¤. μ΄λ° κ²½μ°, Mockingμ„ μ‚¬μ©ν•μ—¬ κ°€μ§(mock) λ°μ΄ν„°λ² μ΄μ¤μ™€ μƒνΈμ‘μ©ν•  μ μμµλ‹λ‹¤.

μλ¥Ό λ“¤μ–΄, Mockingμ„ μ‚¬μ©ν•μ—¬ λ°μ΄ν„°λ² μ΄μ¤μ— μ—°κ²°ν•λ” ν•¨μλ¥Ό κ°€μ§(mock) ν•¨μλ΅ λ€μ²΄ν•  μ μμµλ‹λ‹¤. μ΄λ¥Ό μ„ν•΄ pytest-mock λΌμ΄λΈλ¬λ¦¬λ¥Ό μ„¤μΉν•΄μ•Ό ν•©λ‹λ‹¤.

```python
pip install pytest-mock
```

μ•„λλ” Mockingμ„ μ‚¬μ©ν•μ—¬ ν…μ¤νΈν•λ” μμ‹ μ½”λ“μ…λ‹λ‹¤.

```python
import pytest
from pytest_mock import mocker
from my_module import my_function

def test_my_function(mocker):
    mocker.patch('psycopg2.connect')  # psycopg2.connect ν•¨μλ¥Ό mockμΌλ΅ λ€μ²΄
    
    # ν…μ¤νΈ μ½”λ“ μ‹¤ν–‰
    my_function()
    
    # Mockingν• ν•¨μκ°€ μ λ€λ΅ νΈμ¶λμ—λ”μ§€ ν™•μΈ
    psycopg2.connect.assert_called_once()
```

μ„μ μ½”λ“μ—μ„λ” `mocker.patch` ν•¨μλ¥Ό μ‚¬μ©ν•μ—¬ `psycopg2.connect` ν•¨μλ¥Ό mock ν•¨μλ΅ λ€μ²΄ν•μ€μµλ‹λ‹¤. κ·Έλ° λ‹¤μ `my_function`μ΄ νΈμ¶λ  λ•, mock ν•¨μκ°€ μ λ€λ΅ νΈμ¶λλ”μ§€ ν™•μΈν•κΈ° μ„ν•΄ `assert_called_once()`λ¥Ό μ‚¬μ©ν•μ€μµλ‹λ‹¤.

## λ§μΉλ©°

μ΄ λΈ”λ΅κ·Έ ν¬μ¤νΈμ—μ„λ” Psycopg2λ¥Ό μ‚¬μ©ν•μ—¬ ν…μ¤νΈ λ° Mockingμ„ μ–΄λ–»κ² μν–‰ν•  μ μλ”μ§€ μ•μ•„λ³΄μ•μµλ‹λ‹¤. ν…μ¤νΈλ¥Ό ν†µν•΄ μ½”λ“μ μ‹ λΆ°μ„±μ„ λ†’μ΄κ³  λ²„κ·Έλ¥Ό μµμ†ν™”ν•λ” λ° λ„μ›€μ΄ λ©λ‹λ‹¤. Mockingμ€ μ‹¤μ  λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° μ—†μ΄λ„ λΉ λ¥΄κ² ν…μ¤νΈλ¥Ό μν–‰ν•  μ μλ” λ°©λ²•μ„ μ κ³µν•©λ‹λ‹¤. Psycopg2λ¥Ό μ‚¬μ©ν•λ” κ°λ°μλΌλ©΄ ν…μ¤νΈν•κΈ° μ „μ— μ΄λ¬ν• λ°©λ²•μ„ κ³ λ ¤ν•΄ λ³΄μ‹κΈ° λ°”λλ‹λ‹¤.

Happy coding! π